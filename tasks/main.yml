- name: Deploy Docker Compose stacks
  when: docker_compose_stacks is defined and docker_compose_stacks | length > 0
  block:
    - name: Ensure directory for Docker Compose stacks exists
      ansible.builtin.file:
        path: "{{ item.dest | default(ansible_env.HOME + '/' + item.name) }}"
        state: directory
        mode: '0755'
      with_items: "{{ docker_compose_stacks }}"

    - name: Copy Docker Compose files
      ansible.builtin.template:
        src: "{{ item.src | default(playbook_dir + '/stacks/' + item.name + '/docker-compose.yml.j2') }}"
        dest: "{{ (item.dest | default(ansible_env.HOME + '/' + item.name)) + '/docker-compose.yml' }}" 
      with_items: "{{ docker_compose_stacks }}"

    - name: Find non-template files in src directory
      ansible.builtin.find:
        paths: "{{ item.src | default(playbook_dir + '/stacks/' + item.name) }}"
        recurse: yes
        patterns: "!*.j2"
      register: non_template_files
      with_items: "{{ docker_compose_stacks }}"

    - name: Set fact for found non-template files
      ansible.builtin.set_fact:
        found_files: "{{ non_template_files.results | selectattr('path', 'defined') | list }}"
      when: non_template_files is defined and non_template_files.results | length > 0
      with_items: "{{ docker_compose_stacks }}"
      loop_control:
        loop_var: item

    - name: Copy non-template files
      ansible.builtin.copy:
        src: "{{ non_template_file.path }}"
        dest: "{{ (item.dest | default(ansible_env.HOME + '/' + item.name)) + '/' + non_template_file.path | basename }}"
      when: found_files | length > 0
      with_items: "{{ docker_compose_stacks }}"
      with_nested:
        - "{{ found_files }}"
      loop_control:
        loop_var: non_template_file

    - name: Deploy Docker Compose stack
      community.docker.docker_compose:
        project_src: "{{ item.dest | default(ansible_env.HOME + '/' + item.name) }}"
        files: "docker-compose.yml"
        state: present
      with_items: "{{ docker_compose_stacks }}"
